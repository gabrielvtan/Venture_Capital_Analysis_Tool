{% extends "structure.html" %}
{% block viewport %}
        <!-- Main content -->
        <div class="main-content">
            <!-- Top navbar -->
            <nav class="navbar navbar-top navbar-expand-md navbar-dark" id="navbar-main">
              <div class="container-fluid">
                <!-- Brand -->
                <a class="h1 mb-0 text-white text-uppercase d-none d-lg-inline-block">People Search</a>
                <!-- Form -->
                <form role = "search" class="navbar-search navbar-search-dark form-inline mr-3 d-none d-md-flex ml-lg-auto" id = "investorsearch">
                  <div class="form-group mb-0">
                    <div class="input-group input-group-alternative">
                      <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                      </div>
                        <input type = "text" class="form-control" placeholder="Search" type="text" name = "investorsearch">
                    </div>
                  </div>
                </form>
              </div>
            </nav>
            <!-- Header -->
            <div class="header bg-gradient-primary pb-8 pt-5 pt-lg-8" style="min-height: 500px">
              <div class="container-fluid">
                <div class="header-body">
                  <!-- Card stats -->
                  <div class="row">
  
                    <div class="col-xl-3 col-lg-6">
                      <div class="card card-stats mb-4 mb-xl-0">
                        <div class="card-body">
                          <div class="row">
                            <div class="col">
                              <h5 class="card-title text-uppercase text-muted mb-0">Traffic</h5>
                              <span class="h2 font-weight-bold mb-0">350,897</span>
                            </div>
                            <div class="col-auto">
                              <div class="icon icon-shape bg-danger text-white rounded-circle shadow">
                                <i class="fas fa-chart-bar"></i>
                              </div>
                            </div>
                          </div>
                          <p class="mt-3 mb-0 text-muted text-sm">
                            <span class="text-success mr-2"><i class="fa fa-arrow-up"></i> 3.48%</span>
                            <span class="text-nowrap">Since last month</span>
                          </p>
                        </div>
                      </div>
                    </div>
  
                    <div class="col-xl-3 col-lg-6">
                      <div class="card card-stats mb-4 mb-xl-0">
                        <div class="card-body">
                          <div class="row">
                            <div class="col">
                              <h5 class="card-title text-uppercase text-muted mb-0">New users</h5>
                              <span class="h2 font-weight-bold mb-0">2,356</span>
                            </div>
                            <div class="col-auto">
                              <div class="icon icon-shape bg-warning text-white rounded-circle shadow">
                                <i class="fas fa-chart-pie"></i>
                              </div>
                            </div>
                          </div>
                          <p class="mt-3 mb-0 text-muted text-sm">
                            <span class="text-danger mr-2"><i class="fas fa-arrow-down"></i> 3.48%</span>
                            <span class="text-nowrap">Since last week</span>
                          </p>
                        </div>
                      </div>
                    </div>
  
                    <div class="col-xl-3 col-lg-6">
                      <div class="card card-stats mb-4 mb-xl-0">
                        <div class="card-body">
                          <div class="row">
                            <div class="col">
                              <h5 class="card-title text-uppercase text-muted mb-0">Sales</h5>
                              <span class="h2 font-weight-bold mb-0">924</span>
                            </div>
                            <div class="col-auto">
                              <div class="icon icon-shape bg-yellow text-white rounded-circle shadow">
                                <i class="fas fa-users"></i>
                              </div>
                            </div>
                          </div>
                          <p class="mt-3 mb-0 text-muted text-sm">
                            <span class="text-warning mr-2"><i class="fas fa-arrow-down"></i> 1.10%</span>
                            <span class="text-nowrap">Since yesterday</span>
                          </p>
                        </div>
                      </div>
                    </div>
  
                    <div class="col-xl-3 col-lg-6">
                      <div class="card card-stats mb-4 mb-xl-0">
                        <div class="card-body">
                          <div class="row">
                            <div class="col">
                              <h5 class="card-title text-uppercase text-muted mb-0">Performance</h5>
                              <span class="h2 font-weight-bold mb-0">49,65%</span>
                            </div>
                            <div class="col-auto">
                              <div class="icon icon-shape bg-info text-white rounded-circle shadow">
                                <i class="fas fa-percent"></i>
                              </div>
                            </div>
                            </div>
                              <p class="mt-3 mb-0 text-muted text-sm">
                                <span class="text-success mr-2"><i class="fas fa-arrow-up"></i> 12%</span>
                                <span class="text-nowrap">Since last month</span>
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
  
                  </div>
                </div>
  
  <!-- Page content -->
      <div class="container-fluid mt--7">
          <div class="row">
            <div class="col-xl-4 order-xl-2 mb-5 mb-xl-0">
              <div class="card bg-default shadow">
  
                <div class="row justify-content-center">
                  <div class="col-lg-3 order-lg-2">
                    <div class="card-profile-image">
                      <img src="" class="well" id="poster" width="150" height="150"/>
                    </div>
                  </div>
                </div>
  
                <div class="card-body pt-0 pt-md-4">
                  <div class="text-center">
                    <h3>
                      - <span class="font-weight-light"> - </span>
                    </h3>
                    <div class="h5 font-weight-300">
                      <i class="ni location_pin mr-2"></i> -
                    </div>
                    <div class="h5 mt-4">
                      <i class="ni business_briefcase-24 mr-2"></i> - 
                    </div>
                    <div>
                      <span class="heading" id ="name"></span>
                    </div>
                    <div class="row">
                      <div class="col">
                          <div class="card-profile-stats d-flex justify-content-around mt-md-2">
                          <div>
                              <span class="heading">First Name</span>
                              <span class="description" id ="first_name"></span>
                          </div>
                          <div>
                              <span class="heading">Last Name</span>
                              <span class="description" id="last_name"></span>
                          </div>
                          <div>
                              <span class="heading">Gender</span>
                              <span class="description" id="gender"></span>
                          </div>
                          </div>
                      </div>
                    </div>
                    <div class="row">
                          <div class="col">
                              <div class="card-profile-stats d-flex justify-content-around mt-md-2">
                              <div>
                                  <span class="heading">Date of Birth</span>
                                  <span class="description" id="born_on"></span>
                              </div>
                              <div>
                                  <span class="heading">Primary Location</span>
                                  <span class="description" id="primary_location"></span>
                              </div>
                              </div>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col">
                              <div class="card-profile-stats d-flex justify-content-around mt-md-2">
                              <div>
                                  <span class="heading">Primary Affliation</span>
                                  <span class="description" id ="primary_affiliation"></span>
                              </div>                            
                              <div>
                                  <span class="heading">Title</span>
                                  <span class="description" id="title"></span>
                              </div>
                              </div>
                          </div>
                      </div>
                    <hr class="my-4" />
                    <p id ="bio"></p>
                  </div>
                </div>
              </div>
            </div>
  
       
  
  
              <div class="col-xl-8 order-xl-1">
                  <div class="card bg-default shadow">
  
                      <div class="card-header bg-transparent border-0">
                          <div class="row align-items-center">
                              <div class="col-8">
                              <h3 class="text-white mb-0">Person Details</h3>
                              </div>
                          </div>
                      </div>
  
                      <div class="card-body">
                      <h6 class="heading-small text-muted mb-4">Eduction</h6>
                          <div class="pl-lg-4">
                              <div class="col-md-10 col-sm-10">
                                  <ul id="education" class="description text-white">
                                  </ul>
                              </div>
                          </div>
  
                    <hr class="my-4" />
                    <!-- Investors -->
                    <h6 class="heading-small text-muted mb-4">Jobs</h6>
                    <div class="pl-lg-4">
                        <div class="col-md-10 col-sm-10">
                            <ul id="jobs" class="description text-white">
                            </ul>
                        </div>
                    </div>
  
                    <hr class="my-4" />
                    <!-- Description -->
                    <h6 class="heading-small text-muted mb-4">Investments</h6>
                    <div class="pl-lg-4">
  
                    </div>

                    <hr class="my-4" />
                    <!-- Description -->
                    <h6 class="heading-small text-muted mb-4">Connections</h6>
                    <div class="pl-lg-4">
  
                    </div>
  
                  </div>
              </div>
                <!-- graph -->
              <p></p>
  
              <div class="row">
                  <div class="col">
                      <div class="card shadow border-0">
                          <div id="investorgraph" style="height: 800px;"></div>
                      </div>
                  </div>
              </div>
  
          </div>
      </div>

      <style type="text/css">
        .node circle {
        cursor: pointer;
        stroke: #3182bd;
        stroke-width: 1.5px;
        }
    
        .node text {
        font: 14px sans-serif;
        stroke: #0d2c42;
        pointer-events: none;
        text-anchor: middle;
        }
    
        .link {
        fill: none;
        stroke: #9ecae1;
        stroke-width: 1.5px;
        }
    
        .node.person {
            fill: orange;
        }
    
        .node.rounds {
            fill: rgb(28, 194, 194); 
        }
    
        .node.investment {
            fill: rgb(72, 201, 89); 
        }

        .node.partner_investment{
            fill: rgb(197, 189, 71);
        }

        .node.partner_rounds{
            fill:rgb(84, 84, 163);
        }
    
        .node.hide {
            fill: white;
            stroke: white;
        }
    
    </style>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
    <script src="http://d3js.org/d3-selection-multi.v1.js"></script>
    
    
<script type="text/javascript">
    $(function () {

    function numberWithCommas(x) {
        if (!x) return;
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

    function showPerson(permalink) {
        $.get("/investor/" + encodeURIComponent(permalink),
                function (data) {
                    if (!data) return ;
                    var $list = $("#education").empty();
                    data.education.forEach(function (education) {
                        $list.append($("<li>" + "Attended: " + education.school + 
                            "<li>" + "Start Date: " + education.started_on + 
                            "<li>" + "Degree: " + education.degree_type_name + 
                            "<li>" + "Coursework: " + education.degree_subject + 
                            "<li>" + "Completed Date: " + education.completed_on + "</li>"));
                    });
                }, "json");
        return false;
    }

    function showJobs(permalink) {
        $.get("/investor/" + encodeURIComponent(permalink),
                function (data) {
                    if (!data) return ;
                    var $list = $("#jobs").empty();
                    data.jobs.forEach(function (job) {
                        $list.append($("<li>" + job.title + 
                                        " at " + job.company_name + 
                                        " | " + "is current: " + job.is_current +
                                        " | " + "started on: " + job.started_on + 
                                        "</li>"));
                    });
                }, "json");
        return false;
    }

    function showlocation(permalink) {
        $.get("/investor/" + encodeURIComponent(permalink),
                function (data) {
                    if (!data) return;
                        $("#primary_location").text(data.city)
                        $("#primary_affiliation").text(data.primary_affiliation)
                        $("#title").text(data.primary_title)
                }, "json");
        return false;
    }

    function showGraph(permalink) {
        $.get("/investorgraph/" +encodeURIComponent(permalink),
                function (data) {
                    if (!data) return;
                        var width = 800, 
                            height = 800,
                            min_zoom = 0.1,
                            max_zoom = 7,
                            zoom = d3.behavior.zoom().scaleExtent([min_zoom,max_zoom]),
                            root;

                        var force = d3.layout.force()
                            .gravity(.05)
                            .charge(-150)
                            .linkDistance(100)
                            .friction(0.9)
                            .charge(-400)
                            .size([width, height])
                            .on("tick",tick);

                        var svg = d3.select("#investorgraph").append("svg")
                                .attr("width", "100%")
                                .attr("height", "100%");

                        svg.append('defs').append('marker')
                            .attrs({'id':'arrowhead',
                                'viewBox':'-0 -5 10 10',
                                'refX':13,
                                'refY':0,
                                'orient':'auto',
                                'markerWidth':11,
                                'markerHeight':13,
                                'xoverflow':'visible'})
                            .append('svg:path')
                            .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                            .attr('fill', '#999')
                            .style('stroke','none');

                        var link = svg.selectAll(".link"),
                            node = svg.selectAll(".node");

                        root = data;
                        update();

                        function update() {
                            var nodes = flatten(root),
                                links = root.links;

                            var color = d3.scale.category20();

                            console.log(nodes)
                            console.log(links)
                            // Restart the force layout.
                            force
                                .nodes(nodes)
                                .links(links)
                                .start();

                            // Update the links...
                            link = link.data(links);

                            // Exit any old links
                            link.exit().remove();

                            // Enter any new links
                            link.enter().append("line")
                                .attr("class", "link")
                                .attr('marker-end', 'url(#arrowhead)');
                            
                            // Select edge paths
                            edgepaths = svg.selectAll(".edgepath")
                                .data(links)
                                .enter()
                                .append('path')
                                .attrs({
                                    'class': 'edgepath',
                                    'fill-opacity': 0,
                                    'stroke-opacity': 0,
                                    'id': function (d, i) {return 'edgepath' + i}
                                })
                                .style("pointer-events", "none");
                            
                            // Add edge labels
                            edgelabels = svg.selectAll(".edgelabel")
                                .data(links)
                                .enter()
                                .append('text')
                                .style("pointer-events", "none")
                                .attrs({
                                    'class': 'edgelabel',
                                    'id': function (d, i) {return 'edgelabel' + i},
                                    'font-size': 10,
                                    'fill': '#aaa'
                                });

                            edgelabels.append('textPath')
                                .attr('xlink:href', function (d, i) {return '#edgepath' + i})
                                .style("text-anchor", "middle")
                                .style("pointer-events", "none")
                                .attr("startOffset", "50%")
                                .text(function (d) {return d.action});

                            
                            // Update the nodes...
                            node = node.data(nodes, function(d) {return d.id;});
                            
                            node.exit().remove();

                            var nodeEnter = node.enter().append("g")
                                .attr("class", "node")
                                .attr("cx", function(d) { return d.x; })
                                .attr("cy", function(d) { return d.y; })
                                .on("click", click)
                                .call(force.drag);

                            nodeEnter.append("circle")
                                .attr("r", 20);

                            nodeEnter.append("text")
                                .attr("dy", ".50em")
                                .text(function (d) { return d.name; });

                            nodeEnter.append("text")
                                .attr("dy", ".50em")
                                .text(function (d) { return d.type; });

                            nodeEnter.append("text")
                                .attr("dy", ".50em")
                                .text(function (d) { return d.permalink; });    

                            node.select("circle")
                                .attr("class", function (d) { return "node "+ d.label })
                                                                              
                        }

                        // force feed algo ticks
                        function tick() {
                            link.attr("x1", function(d) { return d.source.x; })
                                .attr("y1", function(d) { return d.source.y; })
                                .attr("x2", function(d) { return d.target.x; })
                                .attr("y2", function(d) { return d.target.y; });
                                
                            node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
                                .attr("cx", function(d) { return d.x; })
                                .attr("cy", function(d) { return d.y; });

                            edgepaths.attr('d', function (d) {
                                return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
                            });

                            edgelabels.attr('transform', function (d) {
                                if (d.target.x < d.source.x) {
                                    var bbox = this.getBBox();

                                    rx = bbox.x + bbox.width / 2;
                                    ry = bbox.y + bbox.height / 2;
                                    return 'rotate(180 ' + rx + ' ' + ry + ')';
                                }
                                else {
                                    return 'rotate(0)';
                                }
                            });
                        }

                        function color(d) {
                            return d._children ? "#3182bd" // collapsed package
                                : d.children ? "#c6dbef" // expanded package
                                : "#fd8d3c"; // leaf node
                        }

                        // Toggle children on click.
                        function click(d) {
                            if (d3.event.defaultPrevented) return; // ignore drag
                            if (d.children) {
                                d._children = d.children;
                                d.children = null;
                            } else {
                                d.children = d._children;
                                d._children = null;
                            }
                            update();
                        }

                        // Returns a list of all nodes under the root.
                        function flatten(root) {
                            var nodes = [], i = 0;

                            function recurse(node) {
                                if (node.nodes) node.nodes.forEach(recurse);
                                if (!node.id) node.id = ++i;
                                nodes.push(node);
                            }

                            recurse(root);
                            return nodes;
                        }

                        function dragstarted(d) {
                            if (!d3.event.active) simulation.alphaTarget(0.3).restart()
                            d.fx = d.x;
                            d.fy = d.y;
                        }

                        function dragged(d) {
                            d.fx = d3.event.x;
                            d.fy = d3.event.y;
                        }

                        function resize() {
                            var width = window.innerWidth, height = window.innerHeight;
                            svg.attr("width", width).attr("height", height);
                            
                            force.size([force.size()[0]+(width-w)/zoom.scale(),force.size()[1]+(height-h)/zoom.scale()]).resume();
                            w = width;
                            h = height;
                        }
                        

                }, "json");
        return false;
    }

    function search() {
        var query=$("#investorsearch").find("input[name=investorsearch]").val();
        $.get("/investorsearch?q=" + encodeURIComponent(query),
                function (data) {
                    if (!data) return;
                        $("#poster").attr("src", data[0].image)
                        $("#first_name").text(data[0].first_name)
                        $("#last_name").text(data[0].last_name)
                        $("#gender").text(data[0].gender)
                        $("#born_on").text(data[0].born_on)
                        $("#bio").text(data[0].bio)
                    showPerson(data[0].permalink);
                    showJobs(data[0].permalink);
                    showGraph(data[0].permalink);
                    showlocation(data[0].permalink);
                }, "json");
        return false;
    }

    $("#investorsearch").submit(search);
    search();
})

</script>

{% endblock viewport %}