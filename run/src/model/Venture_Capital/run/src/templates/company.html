{% extends "structure.html" %}
{% block viewport %}
        <!-- Main content -->
        <div class="main-content">
          <!-- Top navbar -->
          <nav class="navbar navbar-top navbar-expand-md navbar-dark" id="navbar-main">
            <div class="container-fluid">
              <!-- Brand -->
              <a class="h4 mb-0 text-white text-uppercase d-none d-lg-inline-block" href="./index.html">Company Search</a>
              <!-- Form -->
              <form action = "/graph" class="navbar-search navbar-search-dark form-inline mr-3 d-none d-md-flex ml-lg-auto" method = "POST">
                <div class="form-group mb-0">
                  <div class="input-group input-group-alternative">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                      <input name= "company" class="form-control" placeholder="Search" type="text">
                  </div>
                </div>
              </form>
            </div>
          </nav>
          <!-- Header -->
          <div class="header bg-gradient-primary pb-8 pt-5 pt-md-8">
            <div class="container-fluid">
              <div class="header-body">
                <!-- Card stats -->
                <div class="row">

                  <div class="col-xl-3 col-lg-6">
                    <div class="card card-stats mb-4 mb-xl-0">
                      <div class="card-body">
                        <div class="row">
                          <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Traffic</h5>
                            <span class="h2 font-weight-bold mb-0">350,897</span>
                          </div>
                          <div class="col-auto">
                            <div class="icon icon-shape bg-danger text-white rounded-circle shadow">
                              <i class="fas fa-chart-bar"></i>
                            </div>
                          </div>
                        </div>
                        <p class="mt-3 mb-0 text-muted text-sm">
                          <span class="text-success mr-2"><i class="fa fa-arrow-up"></i> 3.48%</span>
                          <span class="text-nowrap">Since last month</span>
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="col-xl-3 col-lg-6">
                    <div class="card card-stats mb-4 mb-xl-0">
                      <div class="card-body">
                        <div class="row">
                          <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">New users</h5>
                            <span class="h2 font-weight-bold mb-0">2,356</span>
                          </div>
                          <div class="col-auto">
                            <div class="icon icon-shape bg-warning text-white rounded-circle shadow">
                              <i class="fas fa-chart-pie"></i>
                            </div>
                          </div>
                        </div>
                        <p class="mt-3 mb-0 text-muted text-sm">
                          <span class="text-danger mr-2"><i class="fas fa-arrow-down"></i> 3.48%</span>
                          <span class="text-nowrap">Since last week</span>
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="col-xl-3 col-lg-6">
                    <div class="card card-stats mb-4 mb-xl-0">
                      <div class="card-body">
                        <div class="row">
                          <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Sales</h5>
                            <span class="h2 font-weight-bold mb-0">924</span>
                          </div>
                          <div class="col-auto">
                            <div class="icon icon-shape bg-yellow text-white rounded-circle shadow">
                              <i class="fas fa-users"></i>
                            </div>
                          </div>
                        </div>
                        <p class="mt-3 mb-0 text-muted text-sm">
                          <span class="text-warning mr-2"><i class="fas fa-arrow-down"></i> 1.10%</span>
                          <span class="text-nowrap">Since yesterday</span>
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="col-xl-3 col-lg-6">
                    <div class="card card-stats mb-4 mb-xl-0">
                      <div class="card-body">
                        <div class="row">
                          <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0">Performance</h5>
                            <span class="h2 font-weight-bold mb-0">49,65%</span>
                          </div>
                          <div class="col-auto">
                            <div class="icon icon-shape bg-info text-white rounded-circle shadow">
                              <i class="fas fa-percent"></i>
                            </div>
                          </div>
                          </div>
                            <p class="mt-3 mb-0 text-muted text-sm">
                              <span class="text-success mr-2"><i class="fas fa-arrow-up"></i> 12%</span>
                              <span class="text-nowrap">Since last month</span>
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                  </div>
                </div>
              </div>
            <div class="container-fluid mt--7">
<!-- Page content -->
<div class="container-fluid mt--7">
    <div class="row">
        <div class="col">
        <div class="card shadow border-0">
            <div id="graph" style="height: 600px;">{{json_data}}</div>
        </div>
        </div>
    </div>
</div>

<style type="text/css">
    .node circle {
    cursor: pointer;
    stroke: #3182bd;
    stroke-width: 1.5px;
    }

    .node text {
    font: 14px sans-serif;
    pointer-events: none;
    text-anchor: middle;
    }

    .link {
    fill: none;
    stroke: #9ecae1;
    stroke-width: 1.5px;
    }

    .node.company {
        fill: red; 
    }

    .node.rounds {
        fill: blue; 
    }

    .node.investor {
        fill: green; 
    }
</style>
<script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
<script src="http://d3js.org/d3-selection-multi.v1.js"></script>

<script type="text/javascript">
    // $(function () {
    //     function showCompany(name) {
    //         $.get("/company/" + encodeURIComponent(name),
    //                 function (data) {
    //                     console.log(data)
    //                     if (!data) return;
    //                     $("#title").text(data.name)
    //                     $("#poster").attr("src", data.image);
    //                     var $list = $("#rounds").empty();
    //                     data.rounds.forEach(function (round) {
    //                         $list.append($("<li>" + round.type + " amount = " +round.money_raised_usd + "</li>"));
    //                     });
    //                 }, "json");
    //         return false;
    //     }
    //     function search() {
    //         var query=$("#search").find("input[name=search]").val();
    //         $.get("/search?q=" + encodeURIComponent(query),
    //                 function (data) {
    //                     var t = $("table#results tbody").empty();
    //                     if (!data || data.length == 0) return;
    //                     data.forEach(function (company) {
    //                         $("#name").text(company.name)
    //                         $("#description").text(company.description)
    //                         $("#raised").text(company.total_funding_usd.toLocaleString())
    //                         $("#categories").text(company.categories)
    //                         $("#primary_role").text(company.primary_role)
    //                         $("#founded_on").text(company.founded_on)
    //                         $("#stock_symbol").text(company.stock_symbol)
    //                         $("#city").text(company.city)
    //                         $("#opening_valuation").text(company.opening_valuation)
    //                         $("#went_public_on").text(company.went_public_on)
    //                         $("#number_of_investments").text(company.number_of_investments)
    //                             .click(function() { showCompany($(this).find("td.company").text());})
    //                     });
    //                     showCompany(data[0].name);
    //                 }, "json");
    //         return false;
    //     }

    //     $("#search").submit(search);
    //     search();
    // })
</script>

<script type="text/javascript">
        var graph = "{{json_data}}";

        graph.replace(/&#([0-9]{1,3});/gi,"1");
        console.log(graph)
    
        parseHtmlEntities(graph);

        var width = 800, 
            height = 800,
            root;

        var force = d3.layout.force()
                .gravity(.05)
                .charge(-150)
                .linkDistance(100)
                .friction(0.9)
                .charge(-400)
                .size([width, height])
                .on("tick",tick);

        var svg = d3.select("#graph").append("svg")
                .attr("width", "100%")
                .attr("height", "100%");

        svg.append('defs').append('marker')
            .attrs({'id':'arrowhead',
                'viewBox':'-0 -5 10 10',
                'refX':13,
                'refY':0,
                'orient':'auto',
                'markerWidth':11,
                'markerHeight':13,
                'xoverflow':'visible'})
            .append('svg:path')
            .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
            .attr('fill', '#999')
            .style('stroke','none');

        var link = svg.selectAll(".link"),
            node = svg.selectAll(".node");

        d3.json("/graph", function(error, graph) {
            // if (error) throw error;

            root = graph;
            update();
        });


        function update() {
            var nodes = flatten(root),
                links = root.links;

            console.log(nodes)
            console.log(links)
            // Restart the force layout.
            force
                .nodes(nodes)
                .links(links)
                .start();

            // Update the links...
            link = link.data(links);

            // Exit any old links
            link.exit().remove();

            // Enter any new links
            link.enter().append("line")
                .attr("class", "link")
                .attr('marker-end', 'url(#arrowhead)');
            
            // Select edge paths
            edgepaths = svg.selectAll(".edgepath")
                .data(links)
                .enter()
                .append('path')
                .attrs({
                    'class': 'edgepath',
                    'fill-opacity': 0,
                    'stroke-opacity': 0,
                    'id': function (d, i) {return 'edgepath' + i}
                })
                .style("pointer-events", "none");
            
            // Add edge labels
            edgelabels = svg.selectAll(".edgelabel")
                .data(links)
                .enter()
                .append('text')
                .style("pointer-events", "none")
                .attrs({
                    'class': 'edgelabel',
                    'id': function (d, i) {return 'edgelabel' + i},
                    'font-size': 10,
                    'fill': '#aaa'
                });

            edgelabels.append('textPath')
                .attr('xlink:href', function (d, i) {return '#edgepath' + i})
                .style("text-anchor", "middle")
                .style("pointer-events", "none")
                .attr("startOffset", "50%")
                .text(function (d) {return d.action});

            
            // Update the nodes...
            node = node.data(nodes, function(d) {return d.id;});

            node.exit().remove();

            var nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; })
                .on("click", click)
                .call(force.drag);

            nodeEnter.append("circle")
                .attr("r", 15);

            nodeEnter.append("text")
                .attr("dy", ".50em")
                .text(function (d) { return d.name; });

            nodeEnter.append("text")
                .attr("dy", ".50em")
                .text(function (d) { return d.type; });

            node.select("circle")
                .attr("class", function (d) { return "node "+ d.label })

        }

        // force feed algo ticks
        function tick() {
            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });
                
            node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });
        
            edgepaths.attr('d', function (d) {
                return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
            });

            edgelabels.attr('transform', function (d) {
                if (d.target.x < d.source.x) {
                    var bbox = this.getBBox();

                    rx = bbox.x + bbox.width / 2;
                    ry = bbox.y + bbox.height / 2;
                    return 'rotate(180 ' + rx + ' ' + ry + ')';
                }
                else {
                    return 'rotate(0)';
                }
            });
        }

        function color(d) {
            return d._children ? "#3182bd" // collapsed package
                : d.children ? "#c6dbef" // expanded package
                : "#fd8d3c"; // leaf node
        }

        // Toggle children on click.
        function click(d) {
            if (d3.event.defaultPrevented) return; // ignore drag
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            update();
        }

        // Returns a list of all nodes under the root.
        function flatten(root) {
            var nodes = [], i = 0;

            function recurse(node) {
                if (node.nodes) node.nodes.forEach(recurse);
                if (!node.id) node.id = ++i;
                nodes.push(node);
            }

            recurse(root);
            return nodes;
        }

        function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart()
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }
        
</script>
{% endblock viewport %}